rule possible_CVE_2025_55182_exploit {

  meta:
    author = "max-h471"
    description = "detects a possible exploitation attempt of CVE-2025-55182, a CVSS 10.0 exploit for React Server Components (RSC) affecting the way the RSC deserializes payloads from HTTP requests to Server Function endpoints"
    severity = "Medium"
    log_type = "MICROSOFT_DEFENDER_ENDPOINT"    

  events:
    $process.metadata.event_type = "PROCESS_LAUNCH"
    (
    ($process.principal.process.file.full_path = /(node|next-server)(\.exe)?$/ nocase and 
    $process.principal.process.command_line = /(server|production|start|app\.js|index\.js|main\.js)/ nocase)
    or
    ($process.principal.process.command_line = /next\s+start/ nocase)
    or
    ($process.principal.process.file.full_path = /bun(\.exe)?$/ nocase and
    $process.principal.process.command_line = /(run|start|serve)/ nocase)
    )
    AND
    (
    ($process.target.process.file.full_path = /((\s|^)nc|ncat|netcat|socat)(\.exe)?$/ nocase or
    $process.target.process.command_line = /(nc\s+-|ncat\s+-|netcat\s+-|socat\s+)/ nocase)
    or
    ($process.target.process.file.full_path = /(bash|sh|zsh|csh|ksh|cmd|powershell|pwsh)(\.exe)?$/
    nocase and $process.target.process.command_line = /(-i|-c\s+[^"']|\/bin\/|C:\\Windows\\)/ nocase)
    or
    ($process.target.process.command_line = /(python[23]?\s+-c|perl\s+-e|ruby\s+-e|php\s+-r)/ nocase)
    or
    ($process.target.process.file.full_path = /(whoami|id)(\.exe)?$/ nocase and
    $process.target.process.command_line != /(npm|yarn|node_modules|package\.json)/ nocase)
    or
    ($process.target.process.command_line = /(curl\s+.*\|\s*(bash|sh|python)|wget\s+.*\|\s*(bash|sh|python)|base64\s+-d.*\|\s*(bash|sh))/ nocase)
    )
    // Exclusions for false positive reduction
    $process.principal.process.command_line != /(npm\s+|yarn\s+|pnpm\s+|node_modules|package\.json|webpack|babel|eslint|jest|mocha|cypress|playwright)/ nocase
    $process.principal.process.command_line != /(localhost|127\.0\.0\.1|0\.0\.0\.0.*300[0-9]|dev|development|test|staging|nodemon|ts-node|tsx)/ nocase
    $process.principal.process.command_line != /(jenkins|gitlab|github|docker|kubernetes|k8s|helm|terraform|ansible|chef|puppet|circleci|travis)/ nocase
    $process.principal.process.command_line != /(pm2|forever|supervisor|systemd|newrelic|datadog|sentry|winston|morgan|pino)/ nocase
    $process.principal.process.command_line != /C:\\Program Files\\|C:\\Windows\\System32\\|\/usr\/bin\/|\/usr\/local\/bin\/|\/opt\// nocase
    (
    $process.principal.process.file.full_path = /(\/var\/www\/|\/opt\/app\/|\/app\/|C:\\inetpub\\|C:\\wwwroot\\)/ nocase
    or
    $process.principal.user.userid = /(www-data|nginx|apache|iis|nobody)/ nocase
    or
    $process.principal.process.command_line = /(port.*80|port.*443|port.*8080|port.*3000)/ nocase
    )

  outcome:
    // For a multi-event rule an aggregation function is required
    // e.g., risk_score = max(0)
    // See https://cloud.google.com/chronicle/docs/detection/yara-l-2-0-overview#outcome_conditionals_example_rule
    $risk_score = 0

  condition:
    $process
}
